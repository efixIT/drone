<script>
  (async function() {
    const gallery = document.getElementById('gallery');
    gallery.innerHTML = ''; // clear loading

    const owner = 'efixIT';
    const repo = 'drone';
    const branch = 'main';

    let currentPath = window.location.pathname
      .replace(/\/index\.htm?$/, '')  // handle both .html and .htm
      .replace(/\/$/, '')
      .split('/').filter(p => p).join('/');

    if (currentPath) currentPath += '/';

    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${currentPath}?ref=${branch}`;

    try {
      const response = await fetch(apiUrl, {
        headers: {
          'Accept': 'application/vnd.github+json',
          'X-GitHub-Api-Version': '2022-11-28',
        }
      });

      if (!response.ok) throw new Error(`API error: ${response.status}`);

      const items = await response.json();

      const htmlFiles = items.filter(item => 
        item.type === 'file' && 
        item.name.toLowerCase().endsWith('.html') &&
        item.name.toLowerCase() !== 'index.html' &&
        item.name.toLowerCase() !== 'index.htm'
      );

      if (htmlFiles.length === 0) {
        gallery.innerHTML = '<p>No model pages found yet.</p>';
        return;
      }

      htmlFiles.forEach(file => {
        let nameWithoutExt = file.name.replace(/\.html$/i, '');
        // Force lowercase for thumb matching (GitHub case-sensitive)
        const thumbBase = nameWithoutExt.toLowerCase();
        let thumbUrl = `${currentPath}${thumbBase}-thumb.png`;

        const card = document.createElement('a');
        card.href = file.name;
        card.className = 'card';
        card.target = '_blank';

        const img = document.createElement('img');
        img.src = thumbUrl;
        img.alt = nameWithoutExt;
        img.className = 'thumbnail';
        img.loading = 'lazy';

        // Better onerror: replace img with placeholder div
        img.onerror = function() {
          const placeholder = document.createElement('div');
          placeholder.className = 'placeholder';
          placeholder.textContent = 'No Preview';
          const container = card.querySelector('.thumb-container');
          if (container) {
            container.innerHTML = '';
            container.appendChild(placeholder);
          }
        };

        card.innerHTML = `
          <div class="thumb-container">${img.outerHTML}</div>
          <div class="info">
            <div class="title">${nameWithoutExt.replace(/-/g, ' ')}</div>
            <div class="desc">Gaussian splat model â€¢ Click to view & inspect</div>
          </div>
        `;

        gallery.appendChild(card);
      });

    } catch (err) {
      console.error(err);
      gallery.innerHTML = `<p style="color: #ff6666;">Error: ${err.message}</p>`;
    }
  })();
</script>
